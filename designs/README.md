# Designs, Their Configuration, useful utilties:


## Adding a design

To add a new design, the following command creates a configuration file for your design:

```bash
./flow.tcl -design <design_name> -init_design_config
```

This will create the following directory structure:

```bash
designs/<design_name>
├── config.tcl
```
In the configuration file, you should edit the required variables and the optional variables, if needed. Further information about the variables can be found [here][2]

Also, the <design_name> could be  replaced by the <design_directory>, which will allow you to run any design on your machine.

**Note: config.tcl is a global configuration for all PDKs. For more information about design configuration files please visit this [section](#configuration-files)**

It is recommended to place the design's verilog files in a `src` directory inside the design's folder as following:

```bash
designs/<design_name>
├── config.tcl
├── src
│   ├── design.v
```

However, you can point to the src files while initializing the design and they will be pointed to automatically in the configuration file and will also be automatically copied to the src directory creating the same structure shown above.

```bash
./flow.tcl -design <design_name> -init_design_config -src <list_verilog_files>
```

Optionally, you can specify the configuration file name (without the extension) by using:

```bash
./flow.tcl -design <design_name> -init_design_config -tag <config_name>
```

After adding the design, you can specify the design name using a `-design` argument:

```bash
./flow.tcl -design <design_name>
```

Finally, you can specify the configuration file (belonging to that design) the flow should use:

```bash
./flow.tcl -design <design_name> -config <config_name>
```


## Configuration files

For each design there is a global config.tcl and other config files one for each PDK:
```bash
designs/<design_name>
├── config.tcl
├── skywater-pdk_sky130_fd_sc_hs_config.tcl
├── skywater-pdk_sky130_fd_sc_hd_config.tcl
├── src
│   ├── design.v
```
The general rule generated by using -init_design_config when adding a design is that the global config.tcl should end with:
```tcl
set filename $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/$::env(PDK)_$::env(PDK_VARIANT)_config.tcl
if { [file exists $filename] == 1} {
	source $filename
}
```
This implies that if the (PDK)_(PDK_VARIANT)_config.tcl doesn't exist the flow would resume normally with only the global config.tcl.

This structure allows for storing the best configurations for a given design on all different PDKs and their PDK_VARIANTs. The best configuration for a given design differ from one PDK and PDK_VARIANT to another.
For this reason, upon installing a new PDK/PDK_VARIANT or a new design, an exploration should be run on different configuration parameters to reach the best configuration. The script that enables this is [here][1]. 
After running the exploration, you will find in the logs two .csv newly generated files: {tag}_{timestamp}.csv and {tag}_{timestamp}_best.csv. The configuration name reported in the _best.csv file contains the best added configurations to the current run of the given design using the specified PDK/PDK_VARIANT.

Two scripts were created for this purpose:
 - A script to create a new configuration file for a given (PDK, PDK_VARIANT) pair, or replicate the configuration of a (PDK, PDK_VARIANT) to another (PDK, PDK_VARIANT).
 - A script to update the configuration of a given (PDK, PDK_VARIANT) according to an exploration result provided by a {tag}_best.csv file.

### Replicate/Create Design Configs for a (PDK,PDK_VARIANT) Pair:

To run the script to create new (empty) configurations for a (PDK,PDK_VARIANT) pair:
```bash
    python3 ./scripts/replicateDesignsConfigs.py --pdkTo PDK --pdkVariantTo PDK_VARIANT
```

To run the script to replicate configurations from one (PDK,PDK_VARIANT) pair to another:
```bash
    python3 ./scripts/replicateDesignsConfigs.py --pdkFrom PDK_FROM --pdkVariantFrom PDK_VARIANT_FROM --pdkTo PDK --pdkVariantTo PDK_VARIANT
```

The following is the list of flags used with the script:
<table>
    <tr>
        <th>
        Argument
        </th>
        <th >
        Description
        </th>
    </tr>
    <tr>
        <td align="center">
            <code>--designs | -d &lt;design1 design2 design3 ...&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Specifies the designs to create/replicate the configs for. <br> Default is to update all designs under designs/
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--root | -r &lt;dirctory&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Sets the root directory. The root should have the following folders under it: designs and scripts. <br> Default is the assumption that the script is called from the openlane root. 
        </td>
    </tr>
    <tr>
        <td align="center">
            <code>--pdkFrom | -pf &lt;PDK&gt;</code> <br> (Optional)
        </td>
        <td align="justify">
            The name of the PDK that the replicated design configuration belongs to. <br> if not specified along with pdkVariantFrom, the script will create a new configuration file for (pdkTo,pdkVariantTo) that is empty.
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--pdkVariantFrom | -pvf &lt;PDK_VARIANT&gt;</code> <br> (Optional)
        </td>
        <td align="justify">
            The name of the PDK_VARIANT that the replicated design configuration belongs to. <br> if not specified along with pdkVariantFrom, the script will create a new configuration file for (pdkTo,pdkVariantTo) that is empty.
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--pdkTo | -pt &lt;PDK&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            The name of the PDK that the created design configurations belongs to.
        </td>
    <tr>
        </tr>
        <td align="center">
            <code>--pdkVariantTo | -pvt &lt;PDK_VARIANT&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            The name of the PDK_VARIANT that the created design configurations belongs to.
        </td>
    </tr>
</table>

### Update Design Configs for a (PDK,PDK_VARIANT) Pair after an Exploration:

To run the script to update configurations for a (PDK,PDK_VARIANT) pair after an exploration:
```bash
    python3 ./scripts/updateDesignsConfigs.py --pdk PDK --pdkVariant PDK_VARIANT -log SW_exploration_best.csv
```

Check [this][1] for more details on the log files.

The following is the list of flags used with the script:
<table>
    <tr>
        <th>
        Argument
        </th>
        <th >
        Description
        </th>
    </tr>
    <tr>
        <td align="center">
            <code>--designs | -d &lt;design1 design2 design3 ...&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Specifies the designs to update the configs for. <br> Default is to update all designs that exist in the given log file (_best.csv)
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--root | -r &lt;dirctory&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Sets the root directory. The root should have the following folders under it: designs, logs, and scripts. <br> Default is the assumption that the script is called from the openlane root. 
        </td>
    </tr>
    <tr>
        <td align="center">
            <code>--pdk | -p &lt;PDK&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            The name of the PDK that the updated design(s) configuration belongs to.
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--pdkVariant | -pv &lt;PDK_VARIANT&gt;</code> <br> (Optional)
        </td>
        <td align="justify">
            The name of the PDK_VARIANT that the updated design(s) configuration belongs to.
        </td>
    </tr>
      <tr>
        </tr>
        <td align="center">
            <code>--log | -l &lt;log file&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            This is the log file containing the best run for each design in a specific exploration. The log file will be used to determine the name of the configuration file to update from.
            The log file provided must lie under root/logs/ and should contain one occurance of each design.
            To tolerate custom log files, the script only exctracts the name of the design and its corresponding configuration from the file. If there were more than one occurance of the same design, the last occurance will override others. 
        </td>
    </tr>
      <tr>
        </tr>
        <td align="center">
            <code>--clean | -cl</code> <br> (Boolean)
        </td>
        <td align="justify">
            Specifies whether or not to delete the configuration file that the updated configuration file is updated from.<br> Default value: <code>False</code>
        </td>
    </tr>
</table>

**Important Note:** *The updateDesignsConfigs script only copies new configuration to the file. The new configurations are marked with a preceeding "# Regression" comment that is automatically written before them by the exploration script. However, the replicateDesignsConfigs copies the whole file.*

[1]: ../regression_results/README.md
[2]: ../configuration/README.md